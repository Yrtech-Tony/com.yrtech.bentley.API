@{
    ViewBag.Title = "Document";
}
<div id="page-wrapper">
    <!--BEGIN CONTENT-->
    <div class="page-content">
        <div id="tab-general">
            <div class="row mbl">
                <div class="col-lg-12">
                    <div class="col-md-12">
                        <div id="area-chart-spline" style="width: 100%; height: 300px; display: none;">
                        </div>
                    </div>
                </div>
                <div class="col-lg-12">
                    <!--BEGIN CONTENT-->
                    <script type="text/javascript">
                        $(function () {
                            $.get("/data/shop.json", {}, function (data) {
                                if (data) {
                                    data = JSON.parse(data);
                                    data.forEach(function (item) {
                                        $("#pdealer").append($("<option>").val(item.ShopId).text(item.ShopName))
                                    });
                                }
                            });
                        })
                    </script>
                    <style>
                        html {
                            overflow: auto;
                            overflow-y: hidden;
                            overflow-x: hidden;
                        }

                        .widget {
                            margin-bottom: 5px !important;
                        }

                        .widget-body {
                            padding: 5px 5px 1px 5px !important;
                        }

                        .page-content {
                            padding: 5px 5px 1px 5px !important;
                        }

                        .fixed-table-pagination div.pagination, .fixed-table-pagination .pagination-detail {
                            margin-top: 5px !important;
                            margin-bottom: 0px !important;
                        }
                    </style>

                    <div id="main-content">
                        <div class="container-fluid">
                            <div class="row-fluid">
                                <div class="span12">

                                    <div class="widget">
                                        <div class="widget-title">
                                            <h4><i class="icon-reorder"></i><span translate>Document Submit</span></h4>
                                            <span class="tools">
                                                <a href="javascript:;" class="icon-chevron-down" onclick="ShowDiv()"></a>
                                            </span>

                                            <select class="input-small m-wrap no-margin" id="pdealer" name="pdealer" style="background-color: white;" onchange="NameQuery()">
                                                <option value="" translate>Dealer Name</option>
                                            </select>
                                        </div>
                                        <div class="widget-body" style="display: block;">
                                            <div class="dataTables_wrapper form-inline" role="grid">
                                                <table id="myPromotion"></table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--END CONTENT-->
                </div>
            </div>
        </div>
    </div>
    <!--END CONTENT-->
    <!--BEGIN FOOTER-->

    <div id="footer" style="display:none">
        <div class="copyright">

        </div>
    </div>
    <!--END FOOTER-->
</div>
@section scripts{
<script src="~/Scripts/api/common.js"></script>
<script>
    $("#nav_promotion2").addClass("active");

    $(function () {

        var columns = [];
        var datas = [];
        $.commonGet("CommitFile/ShopCommitFileRecordStatusSearch", { year: 2020, shopid: 1 }, function (data) {
            console.log(data)
            if (data && data.CommitFileList) {
                var firstHearder = [];
                var secondHearder = [];
                firstHearder.push({
                    title: '经销商',
                    field: 'ShopName',
                    align: 'center',
                    valign: 'middle',
                    rowspan: 2
                });
                data.CommitFileList.filter(function (obj) {
                    return obj.UpperFileId == null;
                }).forEach(function (obj) {
                    var childs = data.CommitFileList.filter(function (child) {
                        return child.UpperFileId == obj.FileId;
                    })
                    firstHearder.push({
                        title: obj.FileName,
                        field: '',
                        align: 'center',
                        valign: 'middle',
                        colspan: childs.length
                    });
                    childs.forEach(function (child) {
                        secondHearder.push({
                            title: child.FileName,
                            field: child.FileId,
                            align: 'center',
                            valign: 'middle',
                            formatter: function (value, row, index) {
                                var params = "ShopId=" + row.ShopId + "&FileId=" + child.FileId;
                                if (value) {
                                    return '<a href="/Document/DocList?' + params + '" class="btn btn-primary btn-sm" style="background-color:gray !important;border-color:lightgrey !important;"><i class="icon-plus" style="padding-right:5px;"></i><span style="color:white;">已提交</span></a>';
                                } else {
                                    return '<a href="/Document/DocList?' + params + '" class="btn btn-primary btn-sm" style=""><i class="icon-plus" style="padding-right:5px;"></i><span style="color:white;">未提交</span></a>';
                                }
                            }
                        })
                    });

                })
                data.ShopList.forEach(function (shop) {
                    var shopName = shop.ShopName;
                    if (localStorage.language == 'en') {
                        shopName = shop.ShopNameEn;
                    }
                    var item = {
                        ShopId: shop.ShopId,
                        ShopName: shopName
                    };
                    secondHearder.forEach(function (col) {
                        item[col.field] = false
                    })
                    datas.push(item);
                })
                var recordList = data.ShopCommitFileRecordStatusList;

                datas.forEach(function (item) {
                    for (var pro in item) {
                        var recordFilter = recordList.filter(function (record) {
                            return record.ShopId == item.ShopId && pro == record.FileId;
                        });
                        if (recordFilter && recordFilter.length > 0) {
                            item[pro] = recordFilter[0].FileCount > 0;
                        }
                    }
                })

                columns.push(firstHearder);
                columns.push(secondHearder);
            }
            $("#myPromotion").bootstrapTable({
                columns: columns,
                data: datas
            });
            console.log(columns)
        })

    })

</script>
}